{% extends 'core/base.html' %} 
{% load static %} 
{% load crispy_forms_tags %} 

{% block css %} 
{% endblock %} 

{% block contenido %}
<div class="container">
    <div class="row">
        <div class="col-12 m-5">
                <h1 class="d-flex justify-content-center align-items-center font-weight-bold text-dark h1"> SUSCRIPCIÓN </h1>
				<br>
				<p class="text-center font-weight-bold text-dark h4">
					Si te suscribes apoyarás a una fundación sin fines de lucro, ¡además recibiras un descuento de un 5% en todos
					los productos para mascotas de la tienda!, todo eso por tan solo $10.000
				</p>
				<br><br>
				{% if user.suscriptor %}
				<a  onclick="eliminarSuscripcion(); return false;" type="submit" class="btn btn-primary btn-block text-light" value="DESUSCRIBIRME">DESUSCRIBIRME</a>
				{% else %}
				<div class="d-flex justify-content-center align-items-center">
                    <div id="btnPaypal"></div>
                </div>
				{% endif %}
				<br><br><br><br><br>
        </div>
    </div>
</div>

     

{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{% static 'core/js/mensajes.js' %}"></script>
<script src="{% static 'core/js/funciones.js' %}"></script>
<script src="https://www.paypalobjects.com/api/checkout.js"></script>
	<script>

		paypal.Button.render({
			env: 'sandbox',
			client: {
				sandbox: 'AUdczilLjDrMGcZtY3F9Xqa4WAmOmJQki8I3sWy9rTnnuxmiPWNOW1RACinASsIaWMDt8QPAbg0JQ1EL',
				production: 'demo_production_client_id'
			},
			locale: 'es_CL',
			style: {
				size: 'large',
				color: 'black',
				shape: 'pill'
			},
			commit: true,
			payment: function (data, actions) {
				return actions.payment.create({
					transactions: [{
						amount: { 
							total: '1.00',
							currency: 'USD'
						}
					}]
				});
			},
			onAuthorize: function (data, actions) {
				return actions.payment.execute().then(function () {
					// LA LOGICA DE LO QUE PASA LUEGO DEL PAGO
					Swal.fire({
						title: 'Confirmación',
						text: 'Pago realizado correctamente!, Ahora eres Suscriptor.',
						icon: 'success',
						showCancelButton: false,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Confirmar'
					}).then((result) => {
						if (result.isConfirmed) {
							// Realizar una solicitud AJAX al servidor para actualizar el campo "suscritor"
							var xhr = new XMLHttpRequest();
							xhr.open('GET', '/actualizar_suscriptor/', true);  // Reemplaza la URL con la ruta correcta
							xhr.setRequestHeader('Content-Type', 'application/json');
							xhr.onload = function () {
								if (xhr.status === 200) {
									console.log(xhr.responseText);
								}
							};
							xhr.send();
						}
					});
				});
			},
			onCancel(data) {
				Swal.fire({
						title: 'Cancelado',
						text: 'Transacción cancelada!',
						icon: 'error',
						showCancelButton: false,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Confirmar'
					})
			},
			onError(err) {
				Swal.fire({
						title: 'Error',
						text: 'Ha ocurrido un error con el pago',
						icon: 'error',
						showCancelButton: false,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Confirmar'
					})
			}

		}, '#btnPaypal');

	</script>
    
{% endblock %}